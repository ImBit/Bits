name: Release and Publish

permissions:
    contents: write

on:
    workflow_dispatch:

jobs:
    build:
        name: Build Release
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v4
                with:
                    fetch-depth: 0

            -   name: Set up JDK 21
                uses: actions/setup-java@v4
                with:
                    java-version: '21'
                    distribution: 'temurin'
                    cache: gradle

            -   name: Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: Determine version
                id: determine-version
                run: |
                    VERSION=$(grep -E "^bits_version=" gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
                    if [ -z "$VERSION" ]; then
                      echo "âŒ Could not read version from gradle.properties"
                      exit 1
                    fi
                    echo "VERSION=$VERSION" >> $GITHUB_ENV
                    echo "Detected version: $VERSION"

            -   name: Build with Gradle
                run: ./gradlew build

            -   name: Update README
                run: |
                    VERSION="${{ env.VERSION }}"
                    sed -i "s/Bits:[0-9.]\+/Bits:$VERSION/g" README.md
                    sed -i "s/<version>[0-9.]\+<\/version>/<version>$VERSION<\/version>/g" README.md

            -   name: Commit README changes
                run: |
                    git config --local user.email "github-actions[bot]@users.noreply.github.com"
                    git config --local user.name "github-actions[bot]"
                    git add README.md
                    git diff --staged --quiet || git commit -m "ðŸ“ Update README to version ${{ env.VERSION }}"
                    git push

            -   name: Generate Changelog
                id: changelog
                run: |
                    export LC_ALL=C.UTF-8
                    export LANG=C.UTF-8
                    
                    git fetch --tags --force

                    CURRENT_TAG="${{ env.VERSION }}"
                    PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -vx "$CURRENT_TAG" | head -n1)

                    if [ -z "$PREVIOUS_TAG" ]; then
                      echo "## ðŸš€ Initial Release $CURRENT_TAG" > changelog.md
                      echo "" >> changelog.md
                      echo "This is the first official release." >> changelog.md
                    else
                      echo "## ðŸš€ Release $CURRENT_TAG" > changelog.md
                      echo "" >> changelog.md

                      git log --pretty=format:"%s (%h)" "$PREVIOUS_TAG"..HEAD > all_commits.txt

                      FEATURES=$(grep -E "^(âœ¨|:sparkles:)" all_commits.txt || true)
                      if [ ! -z "$FEATURES" ]; then
                        echo "### âœ¨ Features" >> changelog.md
                        echo "$FEATURES" | sed -E 's/^(âœ¨|:sparkles:) /\* /' >> changelog.md
                        echo "" >> changelog.md
                      fi

                      BUGFIXES=$(grep -E "^(ðŸ›|:bug:)" all_commits.txt || true)
                      if [ ! -z "$BUGFIXES" ]; then
                        echo "### ðŸ› Bug Fixes" >> changelog.md
                        echo "$BUGFIXES" | sed -E 's/^(ðŸ›|:bug:) /\* /' >> changelog.md
                        echo "" >> changelog.md
                      fi

                      REFACTOR=$(grep -E "^(ðŸŽ¨|:art:)" all_commits.txt || true)
                      if [ ! -z "$REFACTOR" ]; then
                        echo "### ðŸŽ¨ Performance" >> changelog.md
                        echo "$REFACTOR" | sed -E 's/^(ðŸŽ¨|:art:) /\* /' >> changelog.md
                        echo "" >> changelog.md
                      fi

                      OTHER=$(grep -vE "^(âœ¨|:sparkles:|ðŸ›|:bug:|ðŸŽ¨|:art:|Merge)" all_commits.txt || true)
                      if [ ! -z "$OTHER" ]; then
                        echo "### ðŸ“¦ Other Changes" >> changelog.md
                        echo "$OTHER" | sed 's/^/\* /' >> changelog.md
                        echo "" >> changelog.md
                      fi

                      rm -f all_commits.txt
                    fi

                    cat changelog.md

                    CHANGELOG=$(cat changelog.md)
                    echo "changelog<<EOF" >> $GITHUB_OUTPUT
                    echo "$CHANGELOG" >> $GITHUB_OUTPUT
                    echo "EOF" >> $GITHUB_OUTPUT

            -   name: Create Release
                id: create_release
                uses: softprops/action-gh-release@v1
                with:
                    tag_name: ${{ env.VERSION }}
                    name: Release ${{ env.VERSION }}
                    body: ${{ steps.changelog.outputs.changelog }}
                    draft: false
                    prerelease: false
                    files: |
                        API/build/libs/*-${{ env.VERSION }}.jar
                        API/build/libs/*-${{ env.VERSION }}-javadoc.jar
                        Paper/build/libs/*-${{ env.VERSION }}.jar
                        Paper/build/libs/*-${{ env.VERSION }}-javadoc.jar
                        Velocity/build/libs/*-${{ env.VERSION }}.jar
                        Velocity/build/libs/*-${{ env.VERSION }}-javadoc.jar
                        LICENSE
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
