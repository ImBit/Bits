# Creates GitHub releases

name: Release and Publish

permissions:
    contents: write

on:
    workflow_dispatch:
        inputs:
            version:
                description: 'Version to release'
                required: true
                type: string

jobs:
    build:
        name: Build Release
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v4
                with:
                    fetch-depth: 0

            -   name: Set up JDK 21
                uses: actions/setup-java@v4
                with:
                    java-version: '21'
                    distribution: 'temurin'
                    cache: gradle

            -   name: Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: Build with Gradle
                run: ./gradlew build

            -   name: Determine version
                id: determine-version
                run: |
                    if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                      echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
                    else
                      TAG=${GITHUB_REF#refs/tags/v}
                      echo "VERSION=$TAG" >> $GITHUB_ENV
                    fi
                    echo "VERSION=${{ env.VERSION }}"

            -   name: Update README
                run: |
                    VERSION="${{ env.VERSION }}"
                    sed -i "s/Bits:[0-9.]\+/Bits:$VERSION/g" README.md
                    sed -i "s/<version>[0-9.]\+<\/version>/<version>$VERSION<\/version>/g" README.md

            -   name: Commit README changes
                run: |
                    git config --local user.email "github-actions[bot]@users.noreply.github.com"
                    git config --local user.name "github-actions[bot]"
                    git add README.md
                    git diff --staged --quiet || git commit -m "ðŸ“ Update README to version ${{ env.VERSION }}"
                    git push

            -   name: Generate Changelog
                id: changelog
                run: |
                    git fetch --tags --force

                    CURRENT_TAG="v${{ env.VERSION }}"
                    PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -vx "$CURRENT_TAG" | head -n1)

                    if [ -z "$PREVIOUS_TAG" ]; then
                      echo "## ðŸš€ Initial Release $CURRENT_TAG" > changelog.md
                      echo "" >> changelog.md
                      echo "This is the first official release." >> changelog.md
                    else
                      echo "## ðŸš€ Release $CURRENT_TAG" > changelog.md
                      echo "" >> changelog.md

                      FEATURES=$(git log --pretty=format:"%s (%h)" "$PREVIOUS_TAG"..HEAD | grep "^âœ¨" || true)
                      if [ ! -z "$FEATURES" ]; then
                        echo "### âœ¨ Features" >> changelog.md
                        echo "$FEATURES" | sed 's/^âœ¨ /\* /' >> changelog.md
                        echo "" >> changelog.md
                      fi

                      BUGFIXES=$(git log --pretty=format:"%s (%h)" "$PREVIOUS_TAG"..HEAD | grep "^ðŸ›" || true)
                      if [ ! -z "$BUGFIXES" ]; then
                        echo "### ðŸ› Bug Fixes" >> changelog.md
                        echo "$BUGFIXES" | sed 's/^ðŸ› /\* /' >> changelog.md
                        echo "" >> changelog.md
                      fi

                      REFACTOR=$(git log --pretty=format:"%s (%h)" "$PREVIOUS_TAG"..HEAD | grep "^ðŸŽ¨" || true)
                      if [ ! -z "$REFACTOR" ]; then
                        echo "### ðŸŽ¨ Performance" >> changelog.md
                        echo "$REFACTOR" | sed 's/^ðŸŽ¨ /\* /' >> changelog.md
                        echo "" >> changelog.md
                      fi

                      OTHER=$(git log --pretty=format:"%s (%h)" "$PREVIOUS_TAG"..HEAD | grep -v "^âœ¨" | grep -v "^ðŸ›" | grep -v "^ðŸŽ¨" | grep -v "Merge" || true)
                      if [ ! -z "$OTHER" ]; then
                        echo "### ðŸ“¦ Other Changes" >> changelog.md
                        echo "$OTHER" | sed 's/^/\* /' >> changelog.md
                        echo "" >> changelog.md
                      fi
                    fi

                    cat changelog.md

                    CHANGELOG=$(cat changelog.md)
                    echo "changelog<<EOF" >> $GITHUB_OUTPUT
                    echo "$CHANGELOG" >> $GITHUB_OUTPUT
                    echo "EOF" >> $GITHUB_OUTPUT

            -   name: Create Release
                id: create_release
                uses: softprops/action-gh-release@v1
                with:
                    tag_name: v${{ env.VERSION }}
                    name: Release v${{ env.VERSION }}
                    body: ${{ steps.changelog.outputs.changelog }}
                    draft: false
                    prerelease: false
                    files: |
                        API/build/libs/*-${{ env.VERSION }}.jar
                        API/build/libs/*-${{ env.VERSION }}-javadoc.jar
                        Paper/build/libs/*-${{ env.VERSION }}.jar
                        Paper/build/libs/*-${{ env.VERSION }}-javadoc.jar
                        Velocity/build/libs/*-${{ env.VERSION }}.jar
                        Velocity/build/libs/*-${{ env.VERSION }}-javadoc.jar
                        LICENSE
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
